<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <header>  
    <section class="search-section">        
        <img src="data:image/png;base64,<?= imageData ?>" id="logoHome" width="50" height="50">    
        <h1 id="title">   ARC Social     </h1>
    </section>
    <div class="language-selector">
      <button id="langEN" class="lang-btn selected" onclick="setLanguage('en')">English</button>
      <button id="langMR" class="lang-btn" onclick="setLanguage('mr')">‡§Æ‡§∞‡§æ‡§†‡•Ä</button>
    </div>
    </header>

    <div id="homePage">    
      <section class="search-section">
          <input type="text" id="searchBox" placeholder="Search books...">
          <button id="searchButton" class="action-btn">Search</button>
      </section>

      <section class="search-section">
          <button id="browseButton" class="action-btn">Browse my collection</button>
      </section>
      
      <section class="new-books">
          <h2 id="newBooksTitle">Newly Added Books</h2>
          <div class="scroll-container">
              <ul id="newBooksList">
              </ul>
          </div>
      </section>
      
      <section class="upcoming-activities">
          <h2 id="activitiesTitle">Upcoming Activities</h2>
          <div class="scroll-container">
              <ul id="activitiesList">
              </ul>
          </div>    
      </section>
    </div>

  <div id="searchContainer" class="container">
    <div class="filters">
      <div class="filter-row">
        <div class="filter-item">
          <input type="text" id="authorSearch" placeholder="">
          <button id="searchTextBtn" class="action-btn">Search</button>
        </div>
      </div>
    </div>

    <div class="filters">
      <div class="filter-row">
        <div class="filter-item">
          <label for="genreSelect" id="label-genre">Genre</label>
          <select id="genreSelect"></select>
        </div>
        <div class="filter-item">
          <label for="ageGroupSelect" id="label-ageGroup">Age Group</label>
          <select id="ageGroupSelect"></select>
        </div>  
      </div>
      
      <div class="filter-row">
        <div class="filter-item">
          <label for="author" id="label-author">Author</label>
          <select id="authorSelect"></select>
        </div>  
      </div>
      
      <div class="button-container">
        <button id="searchBtn" class="action-btn">Search</button>
        <button id="clearBtn" class="action-btn">Clear</button>
      </div>
    </div>

    <div id="processingMsg" class="processing-message" style="display: none;">
      Processing...
    </div>

    <div class="results-container">
      <div id="bookList" class="book-list"></div>
      <div id="alphabetNav" class="alphabet-nav"></div>
    </div>  
  </div>

  <footer>
      <p id="timing">‚è∞ Library Timings: Mon-Sat 10am-1pm & 5pm-8pm</p>    
      <p id="address"></p>
      <p id="mail">‚úâÔ∏è <a href="mailto:arcsoocial@gmail.com" style='color: #2e7d32;'>arcsoocial@gmail.com</p>      
      <p id="contact"></p>
      <p id="instragram">üì∑ <a href="https://www.instagram.com/arcsoocial" target="_blank">Instagram</p>
  </footer>

  <!-- Load the API Client -->
  <script src="js/library-api-client.js"></script>

  <script>
    let currentLanguage = 'en';
    let currentPage = 'home';
  
    function initialize() {
      
      setLanguage(currentLanguage);

      console.error('getting new books ');
      let books = getNewBooks('NewBooks');
      console.error('got new books ', books.length);

      if (books.length > 0) {
        displayNewBooks(books);
      } 
      
      //getEvents();

      document.getElementById('searchContainer').style.display = 'none';
    }
    
    function setLanguage(lang) {
      currentLanguage = lang;
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.id === `lang${lang.toUpperCase()}`);
      });

      updateTranslations(getTranslations(lang));

      if ( currentPage != 'home' ) { 
        updateFilters(); // filter contents change for language
        searchBooks();   // get the book list for the language
      }
    }

    function updateTranslations(trans) {
      translations = trans;
      document.getElementById('searchBtn').textContent = translations.search;
      document.getElementById('searchTextBtn').textContent = translations.search;
      document.getElementById('clearBtn').textContent = translations.clear;
      document.getElementById('authorSearch').value = '';
      document.getElementById('authorSearch').placeholder = translations.searchtext;
      document.getElementById('processingMsg').textContent = translations.processing;

      document.getElementById("title").textContent = translations.title;
      document.getElementById("label-genre").textContent = translations.genre;
      document.getElementById("label-author").textContent = translations.author;
      document.getElementById("label-ageGroup").textContent = translations.ageGroup;

      document.getElementById('searchBox').value = '';
      document.getElementById("searchBox").placeholder = translations.searchtext;
      document.getElementById("searchButton").innerText = translations.search;
      document.getElementById("browseButton").innerText = translations.browse;
      document.getElementById("newBooksTitle").innerText = translations.newBooks;
      document.getElementById("activitiesTitle").innerText = translations.activities;

      document.getElementById("timing").innerText = translations.timing;

      document.getElementById("address").innerHTML = translations.address;
      document.getElementById("contact").innerHTML = translations.contact;      
    }

    function updateFilters() {
      showProcessing();
      
      google.script.run
        .withSuccessHandler(updateSelect('genreSelect'))
        .getDistinctValues('Genre', currentLanguage);
        
      google.script.run
        .withSuccessHandler(updateSelect('ageGroupSelect'))
        .getDistinctValues('AgeGroup', currentLanguage);
        
      google.script.run
        .withSuccessHandler(updateSelect('authorSelect'))
        .getAuthors(currentLanguage);
    }

    function updateSelect(selectId) {
      return function(values) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">All</option>' +
          values.map(value => `<option value="${value}">${value}</option>`).join('');
        hideProcessing();
      }
    }

    function searchBooksText() {
      let searchText = '';

      if ( currentPage != 'search') {
        showSearch();
        searchText = document.getElementById('searchBox').value;
        document.getElementById('authorSearch').value = searchText;
        updateFilters();        
      }
      else {
        searchText = document.getElementById('authorSearch').value;
      }

      showProcessing();
      
      const filters = {
        language: currentLanguage,
        query: searchText
      };

      google.script.run
        .withSuccessHandler(displayBooks)
        .withFailureHandler(handleError)
        .getFilteredBooks(filters);
    }

    function searchBooks() {
      clearResults();      
      showProcessing();
      const filters = {
        language: currentLanguage,
        genre: document.getElementById('genreSelect').value,
        ageGroup: document.getElementById('ageGroupSelect').value,
        author: document.getElementById('authorSelect').value,
        query: document.getElementById('authorSearch').value
      };

      google.script.run
        .withSuccessHandler(displayBooks)
        .withFailureHandler(handleError)
        .getFilteredBooks(filters);
    }

    function displayBooks(books) {
      const bookList = document.getElementById('bookList');
      const alphabetNav = document.getElementById('alphabetNav');

      if (!books.length) {
        bookList.innerHTML = `<div class="no-results">${translations.noResults}</div>`;
        alphabetNav.style.display = 'none';
        hideProcessing();
        return;
      }
     
      // Get unique first letters of author last names
      const uniqueLetters = [...new Set(
        books.map(book => book.AuthorLastName.charAt(0).toUpperCase())
      )].sort();
  
      // Generate book list HTML
      let currentLetter = '';
      let html = '';
      let count = 0;
      bookList.innerHTML = '';

      books.forEach(book => {
        const letterHeader = book.AuthorLastName.charAt(0).toUpperCase();
        if (letterHeader !== currentLetter) {
          if (currentLetter !== '') {
            html += '</div>'; // Close previous letter-section
            bookList.innerHTML += html;
            html = '';
          }
          currentLetter = letterHeader;
          html += `<div id="section${currentLetter}" class="letter-section">
                    <div class="letter-header">${currentLetter}</div>`;
        }
        html += `<div class="book-item">
                  <strong>${book.Title}</strong> - ${book.Author}
                </div>`;
        count++;      
      });

      if (currentLetter !== '') {
        html += '</div>'; // Close last letter-section
      }

      bookList.innerHTML += html;

      // Update alphabet navigation
      if (books.length >= 10 && uniqueLetters.length >=3 ) {
        alphabetNav.innerHTML = uniqueLetters
          .map(letter => `<div class="letter" onclick="scrollToLetter('${letter}')">${letter}</div>`)
          .join('');
        alphabetNav.style.display = 'flex';
      } else {
        alphabetNav.style.display = 'none';
      }

    document.getElementById("bookList").addEventListener("click", function(event) {      
        if (event.target && (event.target.nodeName === "STRONG" || event.target.nodeName === "DIV") ) {
            showBookDetails(event.target.textContent);
        }
    });

      hideProcessing();
    }

    function showBookDetails(bookTitle) {
        console.error('Error:', bookTitle);      
        alert("Showing book details: ", bookTitle);
        const detailsSection = document.createElement("div");
        detailsSection.style.padding = "20px";
        detailsSection.innerHTML = `<h2>${bookTitle}</h2><p>Details for <strong>${bookTitle}</strong> will be displayed here.</p><button onclick="goBack()">‚¨ÖÔ∏è Back</button>`;

        const contentArea = document.getElementById("searchContainer");
        contentArea.innerHTML = "";
        contentArea.appendChild(detailsSection);
    }

    function goBack() {
        location.reload(); // Reload to restore original main content
    }


    function displayNewBooks(items) {
      const itemList = document.getElementById('newBooksList');
  
      if (!items.length) {
        return;
      }

      // Generate book list HTML
      let html = '';
      itemList.innerHTML = '';

      items.forEach(book => {
        html += `<li>
                  <strong>${book.Title}</strong> - ${book.Author}
                </li>`;
      });

      itemList.innerHTML += html;
    }

    function getEvents() {
      google.script.run
        .withSuccessHandler(displayEvents)
        .withFailureHandler(handleError)
        .getNewBooks('Events');
    }

    function displayEvents(items) {
      const itemList = document.getElementById('activitiesList');
  
      if (!items.length) {
        return;
      }

      // Generate book list HTML
      let html = '';
      itemList.innerHTML = '';

      items.forEach(item => {
        html += `<li>
                  <strong>${item.Date}</strong> - ${item.Event}
                </li>`;
      });

      itemList.innerHTML += html;
    }

    function clearFilters() {
      document.getElementById('genreSelect').value = '';
      document.getElementById('ageGroupSelect').value = '';
      document.getElementById('authorSelect').value = '';
      document.getElementById('authorSearch').value = '';

      clearResults();
    }

    function clearResults() {
      document.getElementById("bookList").innerHTML = ""; // Clears displayed books
      alphabetNav.style.display = 'none';
    }

    function scrollToLetter(letter) {
      const section = document.getElementById(`section${letter}`);
      if (section) {
        section.scrollIntoView({ behavior: 'smooth' });
      }
    }

    function browseBooks() {
      showSearch();
      updateFilters();    
      searchBooks();
    }

    function homePage() {
      hideSearch();
    }

    function showProcessing() {
      document.getElementById('processingMsg').style.display = 'block';
    }

    function hideProcessing() {
      document.getElementById('processingMsg').style.display = 'none';
    }

    function showSearch() {
      currentPage = 'search';
      document.getElementById('homePage').style.display = 'none';      
      document.getElementById('searchContainer').style.display = 'block';
      document.getElementById('searchContainer').style.width = '95%';
      //document.getElementById('searchContainer').style.padding-right = '40px';
    }

    function hideSearch() {
      currentPage = 'home';
      clearResults();      
      document.getElementById('searchContainer').style.display = 'none';
      document.getElementById('homePage').style.display = 'initial';         
    }

    function handleError(error) {
      console.error('Error:', error);
      hideProcessing();
      alert('An error occurred. Please try again.');
    }

    document.getElementById('searchBtn').onclick = searchBooks;
    document.getElementById('clearBtn').onclick = clearFilters;
    document.getElementById('searchTextBtn').onclick = searchBooksText;
    document.getElementById('searchButton').onclick = searchBooksText;
    document.getElementById('browseButton').onclick = browseBooks;
    document.getElementById('logoHome').onclick = homePage;    
    document.getElementById('title').onclick = homePage;

    //window.onload = initialize;

    initialize();
    
  </script>
</body>
</html>


